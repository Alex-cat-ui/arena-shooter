# Hybrid Arena Modules v0.1

## Цель
Сделать генерацию глав управляемой (режиссура, ритм, сценарии), но сохранить вариативность.
Подход: процедурная сборка из авторских модулей, а не полностью случайная геометрия.

## Почему это подходит проекту
- Поддерживает твой стиль: быстрый катана-бой, добивания, плотные choke-зоны.
- Даёт контроль по главам (битва, передышка, пик, финал).
- Убирает часть "уродливых" случайных раскладок.

## Базовая сущность: модуль
Модуль = заранее спроектированный кусок уровня с портами стыковки.

Минимальный формат (GDScript Dictionary):

```gdscript
{
	"id": "entry_bike_alley_a",
	"chapter_pool": [1],
	"size_cells": Vector2i(4, 3),
	"cell_px": 256,
	"ports": [
		{"side": "E", "offset": 1, "width_cells": 1, "type": "normal"},
		{"side": "S", "offset": 2, "width_cells": 1, "type": "normal"}
	],
	"tags": ["entry", "safe_start", "narrow"],
	"weight": 1.0,
	"spawn_rules": {
		"enemy_min": 0,
		"enemy_max": 2,
		"allow_elite": false
	},
	"combat_profile": {
		"line_of_sight": "short",
		"choke_count": 1,
		"execution_spots": 2
	},
	"script_hooks": {
		"on_enter": "intro_bike_drop",
		"on_clear": "unlock_next_gate"
	},
	"scene_path": "res://src/levels/modules/entry_bike_alley_a.tscn"
}
```

## Типы модулей (v0.1)
Нужен небольшой стартовый набор, без оверскоупа.

- `ENTRY`: вход (байк-сцена, безопасный старт, контроль темпа).
- `COMBAT_BOX`: основная комната для melee pressure.
- `CHOKE`: узкий переход/коридор под катану и контроль дистанции.
- `FLANK_LOOP`: обходной путь, чтобы не было линейности.
- `SETPIECE`: сценарный модуль (волна, мини-ивент, редкий bullet-time триггер).
- `FINALE`: финальная арена уровня.

## Шаблон ритма уровня (recipe)
Для каждой главы задаётся рецепт последовательности.

Пример Chapter 1:

```gdscript
{
	"chapter_id": 1,
	"beats": ["ENTRY", "COMBAT_BOX", "CHOKE", "COMBAT_BOX", "FINALE"],
	"optional_branches": 1,
	"max_loops": 1,
	"target_duration_sec": 240,
	"bullet_time": {
		"max_uses_per_level": 1,
		"duration_sec": 2.0,
		"allowed_beats": ["SETPIECE", "FINALE"]
	}
}
```

## Алгоритм сборки (v0.1)

1. Выбрать `chapter_recipe`.
2. Для каждого `beat` выбрать модуль из пула по тегам/весу.
3. Стыковать модули по портам (`port.type`, ширина, side) в клеточной сетке.
4. Добавить 0..N опциональных веток (`optional_branches`).
5. Добавить максимум `max_loops` дополнительных связей (без спама дверями).
6. Привязать `script_hooks` и `spawn_rules` к инстансам модулей.
7. Прогнать валидацию (геометрия, связность, темп).
8. Если fail: ресемплировать модуль/порт, не уничтожая весь уровень сразу.

## Валидация (минимум)
- Связность графа модулей: 100% reachable.
- Ограничения текущего проекта сохраняются:
  - `gut_rect` запрещён.
  - `edge-magistral` запрещён.
  - door caps соблюдены.
- Темп:
  - не более 2 узких модулей подряд,
  - `ENTRY` не содержит тяжёлую волну,
  - `FINALE` всегда присутствует.

## Интеграция с текущим procedural_layout.gd

Вариант без ломки архитектуры:

- Оставить текущий генератор геометрии как low-level слой.
- Добавить новый "macro layout" слой перед ним:
  - `ModuleGraphBuilder` собирает граф модулей,
  - потом каждый модуль отдаёт ограничивающий `Rect2`/набор `Rect2`,
  - текущие системы дверей/валидации применяются поверх.

Рекомендуемая структура файлов:

- `src/systems/module_graph_builder.gd`
- `src/systems/module_catalog.gd`
- `src/levels/modules/*.tscn`
- `src/data/chapter_recipes.gd`

## MVP план (реальный)

1. Сделать 8-12 модулей для Chapter 1.
2. Собрать 1 рецепт главы с 5 beats.
3. Внедрить сборку только для одной главы, остальные оставить на старом procgen.
4. Прогнать `test_hotline_similarity` + отдельный smoke-тест модулей.

## Что даст v0.1
- Контролируемый стиль уровней (ближе к Hotline-режиссуре).
- Сохраняется вариативность.
- Прямая база под "главы по 3-4-5 арен" без хаотичного рандома.
